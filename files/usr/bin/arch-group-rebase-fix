#!/bin/sh
set -eu

TARGET_FILE="/etc/group /etc/gshadow"

GROUPS_TO_REMOVE=$(cat /usr/lib/sysusers.d/*.conf | \
    grep -e "^g" | grep -v -e "^#" | awk 'NF {print $2}' | \
    grep -v -e "wheel" -e "root" -e "sudo" | \
    tr '\n' '|' | sed 's/|$//')

for target_file in $TARGET_FILE; do
	[ -f "$target_file" ] || exit 0
	if [ -n "${GROUPS_TO_REMOVE}" ]; then
		sed -E "/^(${GROUPS_TO_REMOVE}):/d" "${target_file}" > "${target_file}.tmp"
		mv "${target_file}.tmp" "${target_file}"
		chown root:root "${target_file}"
		if [ "$target_file" = "/etc/gshadow" ]; then
			chmod 0000 "${target_file}"
		else
			chmod 644 "${target_file}"
		fi
		touch /etc/arch-group-rebase-fix.stamp
		sync
	fi
done
