#!/bin/sh

set -eu

for i in 1 2 3 4 5; do
    if [ -d "/var/lib" ] && touch /var/lib/.writable_test 2>/dev/null; then
        rm /var/lib/.writable_test
        break
    fi
    sleep 1
done

TARGET_FILE="/etc/group /etc/gshadow"

GROUPS_TO_REMOVE=$(cat /usr/lib/sysusers.d/*.conf | \
    grep -e "^g" | grep -v -e "^#" | awk 'NF {print $2}' | \
    grep -v -e "wheel" -e "root" -e "sudo" | \
    tr '\n' '|' | sed 's/|$//')

for target_file in $TARGET_FILE; do
	[ -f "$target_file" ] || exit 0
	if [ -n "${GROUPS_TO_REMOVE}" ]; then
		sed -E "/^(${GROUPS_TO_REMOVE}):/d" "${target_file}" > "${target_file}.tmp"
		mv "${target_file}.tmp" "${target_file}"
		chown root:root "${target_file}"
		if [ "$target_file" = "/etc/gshadow" ]; then
			chmod 0000 "${target_file}"
		else
			chmod 644 "${target_file}"
		fi
		touch /var/lib/arch-group-rebase-fix.stamp
		sync
	fi
done
