name: xfce-aero-vista
description: XFCE with Vista-like theme, with some modifications.
base-image: ghcr.io/fiftydinar/arch-bootc
image-version: latest

modules:
  - type: pacman
    install:
      packages:
        # GPU acceleration - OpenGL, Vulkan, video decoding/encoding (I won't cover proprietary Nvidia by default)
        - mesa
        - vulkan-radeon
        - vulkan-intel
        - vulkan-nouveau
        - vulkan-swrast
        - libva-intel-driver
        - intel-media-driver
        - libvpl
        - vpl-gpu-rt
        - intel-media-sdk
        # Audio
        - pipewire
        - pipewire-audio
        - pipewire-alsa
        - pipewire-pulse
        - pipewire-jack # pipewire-jack works worse than native jack, but it at least provides compatibility
        - pipewire-libcamera
        - pipewire-v4l2
        - pipewire-ffado
        # Time-sync
        - chrony
        # Network
        - networkmanager
        - wget
        # Bluetooth
        - bluez
        - bluez-obex
        - bluez-mesh
        - bluez-utils
        # Virtual machines
        - virtualbox-guest-utils
        - qemu-guest-agent
        - spice-vdagent
        - phodav
        # Containers
        - distrobox
        # Desktop environment
        - xorg
        - xfce4
        - pasystray
        - cbatticon
        - network-manager-applet
        - obsidian-icon-theme
        - kvantum-qt5
        - kvantum
        - qt5ct
        - qt6ct
        - lightdm
        - lightdm-gtk-greeter
        - xfce4-docklike-plugin
        - xfce4-whiskermenu-plugin
        # CLI editor
        - nano
        # Debugging
        - strace
  - type: script
    snippets:
      # Install script to make AUR package easily
      - "wget --directory-prefix=/tmp/arch-tools/ https://raw.githubusercontent.com/pkgforge-dev/Anylinux-AppImages/refs/heads/main/useful-tools/make-aur-package.sh"
      - "chmod +x /tmp/arch-tools/make-aur-package.sh"
      # Install compiz, emerald, networkmanager-dispatcher-chrony, gtk-nocsd-git, spice-guest-tools-windows
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh gtk2"
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh libwnck"
      ## Enable blur by default and patch it to use emerald decorator directly in compiz
      - |
        cd /tmp/arch-tools && PRE_BUILD_CMDS="sed -i 's|compiztoolbox,|compiztoolbox,blur,|g' ./PKGBUILD" /tmp/arch-tools/make-aur-package.sh compiz
      - |
        sed -i 's|USE_EMERALD="no"|USE_EMERALD="yes"|g /usr/bin/compiz-decorator'
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh emerald"
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh networkmanager-dispatcher-chrony"
      - |
        cd /tmp/arch-tools && PRE_BUILD_CMDS="sed -i 's|LIBDIR=\"/usr/lib\"|LIBDIR=\"/usr/lib\" NOOPT=1|' ./PKGBUILD" /tmp/arch-tools/make-aur-package.sh gtk-nocsd-git
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh spice-guest-tools-windows"
      # Cleanup
      - "rm -r /tmp/arch-tools/"
      # Set bootc update service to not reboot on finished update
      - "sed -i 's|bootc upgrade --apply --quiet|bootc upgrade --quiet|g' /usr/lib/systemd/system/bootc-fetch-apply-updates.service"
      # Fix groups after rebasing from non-Arch image # https://github.com/ExistingPerson08/arch-base
      - |
        echo -e '#!/bin/sh\ncat /usr/lib/sysusers.d/*.conf | grep -e "^g" | grep -v -e "^#" | awk "NF" | awk '\''{print $2}'\'' | grep -v -e "wheel" -e "root" -e "sudo" | xargs -I{} sed -i "/{}/d" "$1"' > /usr/libexec/arch-group-fix
      - "chmod +x /usr/libexec/arch-group-fix"
      - |
        echo -e '[Unit]\nDescription=Fix groups during rebase from Fedora and other images\nDefaultDependencies=no\nAfter=local-fs.target\nBefore=sysinit.target\nWants=local-fs.target\nConditionPathExists=!/var/lib/arch-group-fix.done\n\n[Service]\nType=oneshot\nExecStart=/usr/libexec/arch-group-fix /etc/group\nExecStart=/usr/libexec/arch-group-fix /etc/gshadow\nExecStart=/usr/bin/systemd-sysusers\nExecStartPost=/usr/bin/touch /var/lib/arch-group-fix.done\n\n[Install]\nWantedBy=sysinit.target' > /usr/lib/systemd/system/arch-group-rebase-fix.service
      # Sudo for wheel group # https://github.com/ExistingPerson08/arch-base
      - |
        sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers || echo "%wheel ALL=(ALL:ALL) ALL" >> /etc/sudoers
      # XFCE doesn't have language settings, so set the default language to English and generate locale
      - |
        sed -i 's/^#\s*\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen
      - "locale-gen"
      - "echo 'LANG=en_US.UTF-8' > /etc/locale.conf"
      # Use custom chrony time config
      - "echo -e 'pool pool.ntp.org iburst offline\ndriftfile /var/lib/chrony/drift\nmakestep 1.0 3\nrtcsync' > /etc/chrony.conf"
      # Set nano as the default editor
      - "echo -e 'VISUAL=nano\nEDITOR=nano' >> /etc/environment"
      # Set gtk-nocsd by default
      - "echo 'LD_PRELOAD=/usr/lib/libgtk-nocsd.so' >> /etc/environment"
      # Needed for gtk-nocsd to work in sharun AppImages (we don't preload tons of various libs like SteamOS, so we are safe)
      - "echo 'SHARUN_ALLOW_LD_PRELOAD=1' >> /etc/environment"
      # Set QT apps to use qt{5-6}ct as platform theme (setting it to qt5ct works on both qt5 and qt6)
      - "echo 'QT_QPA_PLATFORMTHEME=qt5ct' >> /etc/environment"
      # Disable coredumps (untransparent, can leak some undesired info and can bloat the storage size)
      - "mkdir -p /usr/lib/systemd/system.conf.d /usr/lib/user/user.conf.d /etc/security/limits.d /usr/lib/sysctl.d"
      - "echo -e '[Manager]\nDumpCore=no' > /usr/lib/systemd/system.conf.d/60-disable-coredump.conf"
      - "echo -e '[Manager]\nDumpCore=no' > /usr/lib/user/user.conf.d/60-disable-coredump.conf"
      - "echo -e '# Disable coredumps\n\n* hard core 0\n* soft core 0' > /etc/security/limits.d/60-disable-coredump.conf"
      - "echo 'kernel.core_pattern = |/bin/false' > /usr/lib/sysctl.d/55-disable-coredump.conf"
      # Set compiz as the default window manager and compositor
      - |
        sed -i 's/value="xfwm4"/value="compiz"/g' /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml
      # Fix bootc-image-builder not liking 2 dots in VERSION_ID for some reason
      - |
        sed -E -i "s/^(VERSION_ID=)(['\"]?)([0-9]{8}\.[0-9]+)\.([0-9]+)(['\"]?)/\\1\"\\3-\\4\"/" /etc/os-release
  - type: systemd
    system:
      disabled:
        - systemd-timesyncd.service
      enabled:
        - arch-group-rebase-fix.service # fix not booting on rebase
        - NetworkManager.service # network handling
        - systemd-resolved.service # DNS resolver
        - chronyd.service # Time-sync
        - bluetooth.service # Bluez Bluetooth service
        - lightdm.service # Display manager
  # This needs to run after pacman or makepkg transactions, because those can install files to /etc and somehow, /usr/etc to /etc begin to conflict
  - type: files
    files:
      - source: usr
        destination: /usr
      - source: etc
        destination: /etc
  - type: signing
  - type: script
    snippets:
      # Show all installed packages sorted by size
      - |
        pacman -Qi | awk -F': ' '/Name/ {n=$2} /Installed Size/ {s=$2} n && s {print n, s; n=s=""}' | column -t | grep MiB | sort -nk 2
