name: xfce-aero-vista
description: XFCE with Vista-like theme, with some modifications.
base-image: ghcr.io/fiftydinar/arch-bootc
image-version: latest

modules:
  - type: pacman
    install:
      packages:
        # GPU acceleration - OpenGL, Vulkan, video decoding/encoding (I won't cover proprietary Nvidia by default)
        - mesa
        - vulkan-radeon
        - vulkan-intel
        - vulkan-nouveau
        - vulkan-swrast
        - libva-intel-driver
        - intel-media-driver
        - libvpl
        - vpl-gpu-rt
        - intel-media-sdk
        # Audio
        - pipewire
        - pipewire-audio
        - pipewire-alsa
        - pipewire-pulse
        - pipewire-jack # pipewire-jack works worse than native jack, but it at least provides compatibility
        - pipewire-libcamera
        - pipewire-v4l2
        - pipewire-ffado
        # Bluetooth
        - bluez
        - bluez-obex
        - bluez-mesh
        - bluez-utils
        # Desktop environment
        - xorg
        - xfce4
        - pasystray
        - cbatticon
        - obsidian-icon-theme
        - kvantum-qt5
        - kvantum
        - qt5ct
        - qt6ct
        - lightdm
        - lightdm-gtk-greeter
        # Debugging stuff
        - strace
  - type: script
    snippets:
      # Install script to make AUR package easily
      - "wget --directory-prefix=/tmp/arch-tools/ https://raw.githubusercontent.com/pkgforge-dev/Anylinux-AppImages/refs/heads/main/useful-tools/make-aur-package.sh"
      - "chmod +x /tmp/arch-tools/make-aur-package.sh"
      # Install compiz, emerald
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh gtk2"
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh libwnck"
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh compiz"
      - "cd /tmp/arch-tools && /tmp/arch-tools/make-aur-package.sh emerald"
      # Cleanup
      - "rm -r /tmp/arch-tools/"
      # Set bootc update service to not reboot on finished update
      - "sed -i 's|bootc upgrade --apply --quiet|bootc upgrade --quiet|g' /usr/lib/systemd/system/bootc-fetch-apply-updates.service"
      # Fix users and group after rebasing from non-Arch image # https://github.com/ExistingPerson08/arch-base
      - "mkdir -p /usr/lib/systemd/system"
      - |
        echo -e '#!/bin/sh\ncat /usr/lib/sysusers.d/*.conf | grep -e "^g" | grep -v -e "^#" | awk "NF" | awk '\''{print $2}'\'' | grep -v -e "wheel" -e "root" -e "sudo" | xargs -I{} sed -i "/{}/d" "$1"' > /usr/libexec/arch-group-fix
      - "chmod +x /usr/libexec/arch-group-fix"
      - |
        echo -e '[Unit]\nDescription=Fix groups during rebase from Fedora and other images\nDefaultDependencies=no\nAfter=local-fs.target\nBefore=sysinit.target\nWants=local-fs.target\nConditionPathExists=!/var/lib/arch-group-fix.done\n\n[Service]\nType=oneshot\nExecStart=/usr/libexec/arch-group-fix /etc/group\nExecStart=/usr/libexec/arch-group-fix /etc/gshadow\nExecStart=/usr/bin/systemd-sysusers\nExecStartPost=/usr/bin/touch /var/lib/arch-group-fix.done\n\n[Install]\nWantedBy=sysinit.target' > /usr/lib/systemd/system/arch-group-rebase-fix.service
      # Sudo for wheel group # https://github.com/ExistingPerson08/arch-base
      - |
        sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers || echo "%wheel ALL=(ALL:ALL) ALL" >> /etc/sudoers
      # XFCE doesn't have language settings, so set the default language to English and generate locale
      - |
        sed -i 's/^#\s*\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen
      - "locale-gen"
      - "echo 'LANG=en_US.UTF-8' > /etc/locale.conf"
      # Fix bootc-image-builder not liking 2 dots in VERSION_ID for some reason
      - |
        sed -E -i "s/^(VERSION_ID=)(['\"]?)([0-9]{8}\.[0-9]+)\.([0-9]+)(['\"]?)/\\1\"\\3-\\4\"/" /etc/os-release
  - type: systemd
    system:
      enabled:
        - arch-group-rebase-fix.service
        - bluetooth.service
        - lightdm.service
  - type: signing
  - type: script
    snippets:
      # Show all installed packages sorted by size
      - |
        pacman -Qi | awk -F': ' '/Name/ {n=$2} /Installed Size/ {s=$2} n && s {print n, s; n=s=""}' | column -t | grep MiB | sort -nk 2
